<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ផតថលពិន្ទុសិស្ស - ប្រព័ន្ធត្រួតពិនិត្យពិន្ទុសិស្ស</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.7/css/dataTables.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.js"></script>
    <style>
        /* Import Kantumruy Pro for Khmer support */
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap');
        
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f8f9fa; /* Default Light Mode Background */
            color: #212529; /* Default Light Mode Text */
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 70px; 
        }
        .header-bg {
            background-color: #0d6efd; 
        }
        .app-container {
            max-width: 1200px;
        }
        /* Custom Colors for Dashboard */
        .bg-orange-100 { background-color: #fef3c7; }
        .text-orange-700 { color: #b45309; }
        .bg-green-100 { background-color: #d1fae5; }
        .text-green-700 { color: #047857; }
        .bg-red-200 { background-color: #fecaca; }
        .text-red-700 { color: #b91c1c; }
        .bg-yellow-100 { background-color: #fffac2; } 
        .text-yellow-700 { color: #a18a00; }
        
        /* Custom Fixed Footer Background (Light Mode only) */
        .footer-custom-bg {
            position: fixed; 
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1030; 
            background-color: #0d6efd; 
            border-top: 3px solid #0056b3;
            color: white;
        }
        .footer-custom-bg a {
            color: #4dc0b5 !important;
        }
        
        /* --- PRINT STYLES --- */
        @media print {
            .no-print { display: none !important; }
            body, html, .card, .modal-content, .card-header { background: white !important; color: black !important; }
            .report-card, .teacher-table { box-shadow: none !important; border: 1px solid #000 !important; color: black !important; }
            .table, .table th, .table td { border-color: #ccc !important; color: black !important; }
            .report-card .bg-gray-100 { background-color: #f0f0f0 !important; }
            .report-card .fw-bold { color: black !important; }
            .report-card .text-primary { color: #0d6efd !important; }
            .report-card .text-muted { color: #6c757d !important; }
            .report-card h4, .report-card h3 { color: black !important; }
            .report-card .small { font-size: 10px !important; }
        }
        
        /* Teacher View Specific Styles for the two tabs */
        .teacher-view-tab .nav-link.active {
            font-weight: bold;
            color: #0d6efd !important;
            border-bottom: 2px solid #0d6efd !important;
        }
        .teacher-view-tab .nav-link {
            color: #6c757d;
            border: none;
        }
    </style>
</head>
<body>
    <div id="app-root">
        </div>
    
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="feedbackModalLabel">មតិកែលម្អដោយ AI</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="feedback-content">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer-custom-bg text-white text-center py-2 no-print shadow-lg">
        <p class="mb-0 small">© ២០២៥ រក្សាសិទ្ធិគ្រប់យ៉ាងដោយ អ៊ូ ជីលាង។ បម្រើសម្រាប់ការអប់រំ និងចំណេះដឹង</p>
        <p class="mb-0 small mt-1">
            អ៊ីម៉ែល: 
            <a href="mailto:chileang.leang76@gmail.com" class="text-info hover:text-blue-200 transition-colors duration-300" target="_blank">
                chileang.leang76@gmail.com
            </a>
            | តេឡេក្រាម: 
            <a href="https://t.me/LeangOCL" class="text-info hover:text-blue-200 transition-colors duration-300" target="_blank">
                095 451 494
            </a>
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js"></script>
    <script>
        // =================================================================
        //                 CONFIGURATION & SECURITY WARNING
        // =================================================================
        const APP_CONFIG = {
            SHEET_ID: "2PACX-1vS2kSwHLe2cnhtDEUQSxq8qjU2PH92P02LVGzjnyL7apuswoYLdSpGmI_yq-MN0gurEQQnBXRwAOvnr",
            POLL_INTERVAL_MS: 60000, // 1 minute
            // NOTE: Teacher credentials removed for security - now checked via /api/login
            // SECURITY NOTE: The Gemini API Key below must be securely proxied through a serverless function 
            // in a production environment to prevent client-side exposure.
            GEMINI_API_KEY: "API_KEY_PLACEHOLDER_SHOULD_BE_HIDDEN_SERVER_SIDE", 
        };
        const BASE_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${APP_CONFIG.SHEET_ID}/pub?output=csv`;
        
        // Headers for Dashboard and Info (must match sheet headers exactly for reliable detection)
        const INFO_HEADERS = {
            lr: 'ល.រ',
            id: 'ID',
            nameKh: 'ឈ្មោះខ្មែរ',
            nameEn: 'ឈ្មោះអង់គ្លេស',
            gender: 'ភេទ',
            room: 'បន្ទប់',
            subject: 'មុខវិជ្ជា',
            skill: 'ជំនាញ',
            totalQHA: 'សរុបពិន្ទុ (Q,H,A)',
            midterm: 'Midterm'
        };
        const AGGREGATE_SCORE_HEADERS = [
            INFO_HEADERS.totalQHA, INFO_HEADERS.midterm
        ];
        
        // Headers that contain student identifying information (not scores)
        const CORE_INFO_HEADERS = [
            INFO_HEADERS.lr, INFO_HEADERS.id, INFO_HEADERS.nameKh, INFO_HEADERS.nameEn, 
            INFO_HEADERS.gender, INFO_HEADERS.room, INFO_HEADERS.subject, INFO_HEADERS.skill
        ];
        
        // --- GLOBAL STATE ---
        let state = {
            data: [],
            headers: [],
            loading: true,
            error: null,
            searchId: localStorage.getItem('lastStudentId') || '',
            student: null,
            colIndexes: {},
            lastUpdated: null,
            pollTimer: null,
            feedbackLoading: false, 
            feedbackError: null,
            isTeacher: false, 
            currentView: 'student', 
            teacherDataTableMode: 'aggregate',
        };
        const root = document.getElementById('app-root');
        
        // =================================================================
        //                            CORE FUNCTIONS
        // =================================================================

        // Helper to safely set text content and attributes
        function setSafeContent(element, content, attribute = 'textContent') {
            if (attribute === 'textContent') {
                element.textContent = content;
            } else if (attribute === 'innerHTML') {
                // WARNING: Use innerHTML only for trusted static content or when unavoidable (like custom icons/SVGs)
                element.innerHTML = content;
            } else {
                element.setAttribute(attribute, content);
            }
        }

        // Refactored to handle complex CSV (quoted fields)
        function parseCSV(text) {
            if (text.trim().startsWith('<!DOCTYPE html>')) return null;
            
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentCell += '"';
                        i++; 
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentCell += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentCell.trim());
                        currentCell = '';
                    } else if (char === '\n' || char === '\r') {
                        if (currentCell || currentRow.length > 0) {
                            // Only push row if it has content
                            currentRow.push(currentCell.trim());
                            rows.push(currentRow);
                            currentRow = [];
                            currentCell = '';
                        }
                        if (char === '\r' && nextChar === '\n') i++;
                    } else {
                        currentCell += char;
                    }
                }
            }
            // Push the last cell/row if not ended with a newline
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            return rows.filter(row => row.some(cell => cell.trim() !== ''));
        }

        async function fetchData() {
            if (!state.lastUpdated) { state.loading = true; }
            state.error = null;
            
            // Clear old timer and render loading state
            if (state.pollTimer) clearInterval(state.pollTimer);
            renderApp();
            
            try {
                // Add timestamp to defeat aggressive browser caching
                const timestamp = new Date().getTime();
                const response = await fetch(`${BASE_CSV_URL}&_t=${timestamp}`, { cache: "no-store" }); 
                
                if (!response.ok) { throw new Error(`Network response was not ok: ${response.status}`); }
                
                const text = await response.text();
                const parsed = parseCSV(text);
                
                if (!parsed || parsed.length === 0) { throw new Error("HTML_DETECTED"); }
                
                const headerRow = parsed[0];
                const dataRows = parsed.slice(1).filter(row => row.some(cell => cell.trim() !== ''));
                
                state.headers = headerRow;
                state.data = dataRows;
                let newIndexes = {};
                
                // Map headers to column indices
                headerRow.forEach((h, i) => {
                    const hLower = h.toLowerCase().trim();
                    const exactKey = Object.keys(INFO_HEADERS).find(k => INFO_HEADERS[k].toLowerCase() === hLower);
                    if (exactKey) { newIndexes[exactKey] = i; } 
                });
                
                // Fallback detection for aggregate scores
                if (newIndexes.totalQHA === undefined) newIndexes.totalQHA = headerRow.findIndex(h => h.includes('សរុបពិន្ទុ') && h.includes('(Q,H,A)'));
                if (newIndexes.midterm === undefined) newIndexes.midterm = headerRow.findIndex(h => h.toLowerCase().trim() === 'midterm');
                if (newIndexes.id === undefined) newIndexes.id = headerRow.findIndex(h => INFO_HEADERS.id.toLowerCase() === h.toLowerCase().trim()); // Recheck ID
                
                state.colIndexes = newIndexes;
                state.lastUpdated = new Date(); 
                
                // Keep the current student object updated if in result view
                if (state.student && state.colIndexes.id !== undefined && state.colIndexes.id !== -1) {
                    const target = state.student[state.colIndexes.id].toString().toLowerCase().trim();
                    const updatedResult = state.data.find(row => {
                        const val = row[state.colIndexes.id];
                        return val && val.toString().toLowerCase().trim() === target;
                    });
                    if (updatedResult) { state.student = updatedResult; } else { state.student = null; }
                }

            } catch (err) {
                if (err.message === "HTML_DETECTED") { state.error = "PUBLISH_ERROR"; } else { state.error = "NETWORK_ERROR"; console.error("Fetch Error:", err); }
            } finally {
                state.loading = false;
                state.pollTimer = setInterval(fetchData, APP_CONFIG.POLL_INTERVAL_MS);
                renderApp();
            }
        }

        // --- MANUAL REFRESH HANDLER ---
        function handleManualRefresh() {
            if (state.pollTimer) { clearInterval(state.pollTimer); state.pollTimer = null; }
            fetchData();
        }

        // --- EXPORT CSV HANDLER ---
        function exportCSV() {
            const dataToExport = state.data;
            let csvContent = state.headers
                .map(h => `"${(h || '').toString().replace(/"/g, '""')}"`)
                .join(',') + '\n';

            dataToExport.forEach(row => {
                const rowString = row
                    .map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`)
                    .join(',');
                csvContent += rowString + '\n';
            });

            const bom = "\ufeff";
            const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8;" });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "Student_Scores_Export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- AUTHENTICATION (SECURE CALL TO SERVERLESS FUNCTION) ---
        async function handleTeacherLogin(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('teacher-username');
            const passwordInput = document.getElementById('teacher-password');
            const message = document.getElementById('login-message');
            
            usernameInput.classList.remove('is-invalid');
            passwordInput.classList.remove('is-invalid');
            message.innerHTML = ''; // Safely clear old message
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            let isValid = true;
            if (!username) { usernameInput.classList.add('is-invalid'); isValid = false; }
            if (!password) { passwordInput.classList.add('is-invalid'); isValid = false; }

            if (!isValid) {
                message.innerHTML = `<div class="alert alert-danger p-2 mt-3 small fw-bold">សូមបញ្ចូលឈ្មោះអ្នកប្រើប្រាស់ និងពាក្យសម្ងាត់។</div>`;
                return;
            }
            
            message.innerHTML = `<div class="p-2 mt-3 small fw-bold text-primary">កំពុងផ្ទៀងផ្ទាត់...</div>`;

            // --- SECURE AUTHENTICATION VIA SERVERLESS FUNCTION ---
            try {
                // Ensure no local authentication is performed
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Security Note: Sending credentials over HTTPS to a trusted API endpoint.
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Success
                    state.isTeacher = true;
                    state.student = null;
                    message.innerHTML = `<div class="alert alert-success p-2 mt-3 small fw-bold">ចូលបានជោគជ័យ!</div>`;
                    if (window.jQuery && $.fn.DataTable.isDataTable('#teacher-data-table')) {
                        $('#teacher-data-table').DataTable().destroy();
                    }
                    renderApp();
                } else {
                    // Failure: Use the error message returned from the serverless function
                    usernameInput.classList.add('is-invalid');
                    passwordInput.classList.add('is-invalid');
                    const errorMessage = result.message || 'ឈ្មោះអ្នកប្រើ ឬពាក្យសម្ងាត់មិនត្រឹមត្រូវ។';
                    message.innerHTML = `<div class="alert alert-danger p-2 mt-3 small fw-bold">${errorMessage}</div>`;
                }

            } catch (error) {
                console.error("Login API call failed:", error);
                message.innerHTML = `<div class="alert alert-danger p-2 mt-3 small fw-bold">មានបញ្ហាការតភ្ជាប់បណ្តាញ។</div>`;
            }
        }
        function handleTeacherLogout() {
            state.isTeacher = false;
            if (window.jQuery && $.fn.DataTable.isDataTable('#teacher-data-table')) {
                $('#teacher-data-table').DataTable().destroy();
            }
            renderApp();
        }

        // --- STUDENT SEARCH FUNCTION (Strict ID match for security) ---
        function handleSearch(e) {
            e.preventDefault();
            const searchInput = document.getElementById('search-input');
            const messageContainer = document.getElementById('search-message');

            searchInput.classList.remove('is-invalid');
            messageContainer.textContent = ''; // Safer: use textContent to clear

            const target = searchInput.value.trim().toLowerCase();
            state.searchId = target;

            if (!target) {
                searchInput.classList.add('is-invalid');
                messageContainer.innerHTML = `<div class="alert alert-danger p-2 mt-3 small fw-bold" role="alert"><strong>សូមបញ្ចូលអត្តលេខសិស្សពេញលេញ។</strong></div>`;
                return;
            }

            const indexes = state.colIndexes;
            const idCol = indexes.id;
            
            const result = state.data.find(row => {
                const idVal = row[idCol] ? row[idCol].toString().toLowerCase().trim() : '';
                return idVal === target;
            });
            
            if (result) {
                state.student = result;
                localStorage.setItem('lastStudentId', target); 
                renderApp();
            } else {
                state.student = null;
                searchInput.classList.add('is-invalid');
                messageContainer.innerHTML = `<div class="alert alert-danger p-2 mt-3 small fw-bold" role="alert"><strong>រកមិនឃើញអត្តលេខសិស្សពេញលេញនេះទេ។ សូមបញ្ចូលអត្តលេខពេញលេញ។</strong></div>`;
            }
        }

        // --- GO BACK HANDLER ---
        function handleBack() {
            state.student = null;
            renderApp();
        }
        
        // --- DATA TABLE MODE SWITCHER ---
        function setTeacherDataTableMode(mode) {
            if (state.teacherDataTableMode !== mode) {
                state.teacherDataTableMode = mode;
                renderApp(); 
            }
        }


        // --- DATATABLES INITIALIZATION (Optimized for performance) ---
        function setupDataTable() {
            if (!state.isTeacher || state.data.length === 0 || !window.jQuery || !window.DataTable) return;

            const $table = $('#teacher-data-table');

            // Destroy existing instance before re-initialization
            if ($.fn.DataTable.isDataTable('#teacher-data-table')) {
                $table.DataTable().destroy();
                $table.empty();
            }

            const isAggregateMode = state.teacherDataTableMode === 'aggregate';
            const indexes = state.colIndexes;
            
            const infoIndexes = CORE_INFO_HEADERS
                .map(hKey => indexes[Object.keys(INFO_HEADERS).find(k => INFO_HEADERS[k] === hKey)])
                .filter(i => i !== undefined && i !== -1);

            let columnIndexesToShow = []; 

            if (isAggregateMode) {
                const aggIndexes = AGGREGATE_SCORE_HEADERS
                    .map(hKey => indexes[Object.keys(INFO_HEADERS).find(k => INFO_HEADERS[k] === hKey)])
                    .filter(i => i !== undefined && i !== -1);
                columnIndexesToShow.push(...infoIndexes, ...aggIndexes);
                // Filter out duplicates if present
                columnIndexesToShow = [...new Set(columnIndexesToShow)];
            } else {
                // Detailed mode: show all, but ensure core info is first for structure, and remove aggregate score duplicates
                columnIndexesToShow = Array.from({ length: state.headers.length }, (_, i) => i);
                const aggregateIndices = [indexes.totalQHA, indexes.midterm];
                
                // Keep only unique columns
                const allUnique = [...new Set(columnIndexesToShow)];
                
                // Prioritize info columns at the start
                const infoSet = new Set(infoIndexes);
                const orderedColumns = infoIndexes.concat(allUnique.filter(i => !infoSet.has(i)));
                columnIndexesToShow = orderedColumns;
            }
            
            const columns = columnIndexesToShow.map((originalIndex, relativeIndex) => ({
                title: state.headers[originalIndex],
                data: null, 
                // Render function is required by DataTables when passing raw array data
                render: function (data, type, row) {
                    // row is the array of data *for the visible columns*
                    return row[relativeIndex] || '';
                },
                // Set ordering based on column type (usually score columns are sortable)
                orderable: !infoIndexes.includes(originalIndex), 
            }));

            // Prepare the data rows to contain only the visible columns' data
            const tableData = state.data.map(row => {
                return columnIndexesToShow.map(index => row[index]);
            });


            $table.DataTable({
                language: {
                    search: "ស្វែងរកទិន្នន័យ:",
                    info: "កំពុងបង្ហាញ _START_ ដល់ _END_ នៃ _TOTAL_ កំណត់ត្រា",
                    infoEmpty: "គ្មានកំណត់ត្រា",
                    infoFiltered: "(ច្រោះចេញពី _MAX_ កំណត់ត្រាសរុុប)",
                    lengthMenu: "បង្ហាញ _MENU_ កំណត់ត្រា",
                    paginate: { first: "ដំបូង", last: "ចុងក្រោយ", next: "បន្ទាប់", previous: "មុន" },
                    zeroRecords: "រកមិនឃើញទិន្នន័យដែលត្រូវគ្នា។"
                },
                data: tableData,
                columns: columns,
                searching: true,
                ordering: true,
                paging: true,
                scrollX: true,
                dom: '<"row mb-3"<"col-md-6"l><"col-md-6"f>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
                columnDefs: [{ targets: infoIndexes.map((_, i) => i), orderable: false }] // Disable ordering on info columns if needed
            });
        }
        
        // --- HELPER FUNCTIONS FOR CALCULATIONS (Unchanged for logic) ---

        function getQhaGrade(numericTotalQHA) {
             let grade = { label: 'N/A (មិនអាចវាយតម្លៃបាន)', color: 'text-secondary', bg: 'bg-light' };
            if (numericTotalQHA !== null && !isNaN(numericTotalQHA)) {
                if (numericTotalQHA < 7.5) { grade = { label: 'Bad (ខ្សោយខ្លាំង)', color: 'text-red-700', bg: 'bg-red-200' }; } 
                else if (numericTotalQHA >= 14.0 && numericTotalQHA <= 15.0) { grade = { label: 'Very Good (ល្អណាស់)', color: 'text-orange-700', bg: 'bg-orange-100' }; } 
                else if (numericTotalQHA >= 7.5) { grade = { label: 'Good (ល្អ)', color: 'text-orange-700', bg: 'bg-orange-100' }; }
            }
            return grade;
        }
        function getMidtermGrade(numericMidterm) {
            let grade = { label: 'N/A (មិនអាចវាយតម្លៃបាន)', color: 'text-secondary', bg: 'bg-light' };
            if (numericMidterm !== null && !isNaN(numericMidterm)) {
                if (numericMidterm >= 12.5) { grade = { label: 'Passed (ជាប់)', color: 'text-green-700', bg: 'bg-green-100' }; } 
                else { grade = { label: 'Failed (ធ្លាក់)', color: 'text-red-700', bg: 'bg-red-200' }; }
            }
            return grade;
        }
        function calculateStats(student) {
            if (!student || !state.headers.length) return null;
            const indexes = state.colIndexes;
            const infoHeaderValues = CORE_INFO_HEADERS.map(h => h.toLowerCase().trim());
            const aggregateHeaderValues = AGGREGATE_SCORE_HEADERS.map(h => h.toLowerCase().trim());
            const knownHeadersSet = new Set([...infoHeaderValues, ...aggregateHeaderValues]);
            
            const detailedScores = state.headers.map((headerText, i) => {
                const headerLower = headerText.toLowerCase().trim();
                // Filter out known info/aggregate headers
                if (knownHeadersSet.has(headerLower)) return null;
                const val = parseFloat(student[i]);
                // Only include if it is a valid number AND the cell content isn't empty/whitespace
                if (!isNaN(val) && student[i] && student[i].trim() !== '') return { subject: headerText, score: val, index: i };
                return null;
            }).filter(Boolean);
            
            // Recalculate if aggregates are missing in sheet
            let sumForAvg = detailedScores.reduce((sum, s) => sum + s.score, 0);
            let countForAvg = detailedScores.length;
            
            const totalQHAValue = indexes.totalQHA !== undefined && student[indexes.totalQHA] ? (parseFloat(student[indexes.totalQHA]) || 0).toFixed(2) : null;
            const numericTotalQHA = totalQHAValue !== null ? parseFloat(totalQHAValue) : null;
            
            const midtermValue = indexes.midterm !== undefined && student[indexes.midterm] ? (parseFloat(student[indexes.midterm]) || 0).toFixed(2) : null;
            const numericMidterm = midtermValue !== null ? parseFloat(midtermValue) : null;
            
            const totalQHAIndex = indexes.totalQHA;
            const rankPrecision = 100;
            const totalStudentsInSheet = state.data.length;
            
            const allQHAScores = state.data.map(row => {
                if (totalQHAIndex !== undefined && totalQHAIndex !== -1 && row[totalQHAIndex]) {
                    const score = parseFloat(row[totalQHAIndex]);
                    return (!isNaN(score) && score >= 0) ? Math.round(score * rankPrecision) / rankPrecision : -1;
                }
                return -1;
            }).filter(score => score !== -1); 
            
            const currentQHAScoreRounded = numericTotalQHA !== null ? Math.round(numericTotalQHA * rankPrecision) / rankPrecision : -1;
            const sortedQHAScores = [...allQHAScores].sort((a, b) => b - a);
            
            let rank = 'N/A';
            if (currentQHAScoreRounded !== -1 && sortedQHAScores.length > 0) {
                const position = sortedQHAScores.findIndex(score => score === currentQHAScoreRounded);
                if (position !== -1) { rank = position + 1; }
            }
            
            const qhaGradeStatus = getQhaGrade(numericTotalQHA);
            const midtermGradeStatus = getMidtermGrade(numericMidterm);
            
            return { 
                detailedScores, rank: rank, totalStudentsInSheet: totalStudentsInSheet, qhaGradeStatus: qhaGradeStatus,
                midtermGradeStatus: midtermGradeStatus, totalQHAValue, midtermValue, studentNameKh: getStudentInfo('nameKh')
            };
        }
        function calculateTeacherStatistics() {
            if (state.data.length === 0) return { avgQHA: 'N/A', avgMidterm: 'N/A', totalStudents: 0, passRateMidterm: 'N/A', goodRateQHA: 'N/A', distribution: [] };
            const indexes = state.colIndexes;
            const qhaIndex = indexes.totalQHA;
            const midtermIndex = indexes.midterm;
            let totalQHA = 0; let totalMidterm = 0; let countQHA = 0; let countMidterm = 0; let passCount = 0; let goodCount = 0;
            
            state.data.forEach(row => {
                const qha = parseFloat(row[qhaIndex]); 
                const midterm = parseFloat(row[midtermIndex]);
                
                if (!isNaN(qha)) { totalQHA += qha; countQHA++; if (qha >= 7.5) goodCount++; }
                if (!isNaN(midterm)) { totalMidterm += midterm; countMidterm++; if (midterm >= 12.5) passCount++; }
            });
            
            const avgQHA = countQHA ? (totalQHA / countQHA).toFixed(2) : 'N/A';
            const avgMidterm = countMidterm ? (totalMidterm / countMidterm).toFixed(2) : 'N/A';
            const totalStudents = state.data.length;
            
            return {
                avgQHA: avgQHA, avgMidterm: avgMidterm, totalStudents: totalStudents,
                passRateMidterm: totalStudents ? ((passCount / totalStudents) * 100).toFixed(1) : 'N/A',
                goodRateQHA: totalStudents ? ((goodCount / totalStudents) * 100).toFixed(1) : 'N/A',
                distribution: [{ label: 'សិស្សសរុប', value: totalStudents, color: 'text-primary' }]
            };
        }
        function getStudentInfo(key, row = state.student) {
            const index = state.colIndexes[key];
            // Ensure index is valid before accessing array element
            return index !== undefined && index !== -1 && row && row[index] !== undefined ? row[index] : 'N/A';
        }

        async function getLLMFeedback(stats) {
            state.feedbackLoading = true;
            state.feedbackError = null;
            const feedbackContent = document.getElementById('feedback-content');
            
            // Show Modal and Loading State
            if (window.bootstrap) { 
                const modal = new bootstrap.Modal(document.getElementById('feedbackModal')); 
                modal.show(); 
            }
            feedbackContent.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">កំពុងផ្ទុក...</span></div><p class="mt-2 text-muted">AI កំពុងវិភាគលទ្ធផល...</p></div>`;
            renderApp(); // Update button state
            
            const systemPrompt = "Act as an experienced, kind, and encouraging Cambodian academic advisor. Your response MUST be written in the Khmer language. Analyze the student's QHA status (Quiz/Homework/Attendance) and Midterm status to provide personalized, constructive feedback and advice on how they can improve or maintain their performance.";
            const userQuery = `Student Name: ${stats.studentNameKh}. QHA Status: ${stats.qhaGradeStatus.label} (${stats.totalQHAValue}). Midterm Status: ${stats.midtermGradeStatus.label} (${stats.midtermValue}). Provide a short, motivating, and actionable paragraph of advice based on these results.`;
            
            // SECURITY NOTE: In a production environment, this should point to a secure, server-side proxy
            // that uses the actual API key and returns ONLY the response text.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${APP_CONFIG.GEMINI_API_KEY}`;
            
            const payload = { 
                contents: [{ parts: [{ text: userQuery }] }], 
                systemInstruction: { parts: [{ text: systemPrompt }] }, 
                config: { tools: [{ googleSearch: {} }] } 
            };
            
            let responseText = "ការវិភាគមិនដំណើរការ។ សូមព្យាយាមម្តងទៀត។"; 
            state.feedbackError = "AI_EMPTY_RESPONSE";
            
            const MAX_RETRIES = 3; 
            let delay = 1000;
            
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    
                    const result = await response.json(); 
                    const candidate = result.candidates?.[0];
                    
                    if (candidate && candidate.content?.parts?.[0]?.text) { 
                        responseText = candidate.content.parts[0].text; 
                        state.feedbackError = null; 
                        break; 
                    } else { 
                        throw new Error("Empty AI content or blocked."); 
                    }
                    
                } catch (error) {
                    console.error(`Gemini API Error (Attempt ${attempt + 1}/${MAX_RETRIES}):`, error);
                    if (attempt < MAX_RETRIES - 1) {
                        const waitTime = delay * Math.pow(2, attempt);
                        await new Promise(resolve => setTimeout(resolve, Math.min(waitTime, 8000))); 
                    } else {
                        state.feedbackError = "FAILED_AFTER_RETRIES";
                        responseText = "ការវិភាគមិនដំណើរការបន្ទាប់ពីព្យាយាមច្រើនដង។ សូមពិនិត្យការតភ្ជាប់អ៊ីនធឺណិតរបស់អ្នក ឬព្យាយាមម្តងទៀតនៅពេលក្រោយ។";
                    }
                }
            }
            
            state.feedbackLoading = false;
            
            // Set final content
            if (state.feedbackError) {
                let displayError = (state.feedbackError === "FAILED_AFTER_RETRIES") ? "បរាជ័យក្នុងការវិភាគ" : "Received empty response from AI";
                feedbackContent.innerHTML = `<div class="alert alert-danger">${responseText} (កំហុស: ${displayError})</div>`;
            } else {
                // Use DOM manipulation to inject text safely
                const p = document.createElement('p');
                p.className = 'fw-medium';
                setSafeContent(p, responseText);
                feedbackContent.innerHTML = '';
                feedbackContent.appendChild(p);
            }
            renderApp();
        }

        // --- DOM RENDER FUNCTIONS (CRITICAL REFACTOR FOR XSS PREVENTION) ---

        function renderHeader() {
            const header = document.createElement('header');
            setSafeContent(header, `
                <div class="container app-container mx-auto px-3 py-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-white"><path d="M4 19.5V10l8-7 8 7v9.5a.5.5 0 0 1-.5.5h-15a.5.5 0 0 1-.5-.5Z"/><path d="M8 12.5v7.5"/><path d="M12 12.5v7.5"/><path d="M16 12.5v7.5"/></svg>
                        <div><h1 class="h5 mb-0 fw-bold">ផតថលពិន្ទុសិស្ស</h1><p class="mb-0 text-sm text-blue-200">ប្រព័ន្ធត្រួតពិនិត្យពិន្ទុសិស្ស</p></div>
                    </div>
                    <div class="d-flex gap-2" id="header-action-buttons"></div>
                </div>
            `, 'innerHTML');
            header.className = "header-bg text-white shadow sticky-top no-print";

            const actionContainer = header.querySelector('#header-action-buttons');
            const isResultView = state.student !== null;
            const isTeacherView = state.isTeacher;

            if (isTeacherView) {
                const logoutBtn = document.createElement('button');
                logoutBtn.className = "btn btn-sm btn-light fw-bold";
                setSafeContent(logoutBtn, "ចាកចេញ (គ្រូ)");
                logoutBtn.addEventListener('click', handleTeacherLogout);
                actionContainer.appendChild(logoutBtn);
            } else if (isResultView) {
                const backBtn = document.createElement('button');
                backBtn.className = "btn btn-sm btn-light fw-bold";
                setSafeContent(backBtn, "ត្រលប់ក្រោយ");
                backBtn.addEventListener('click', handleBack);
                actionContainer.appendChild(backBtn);
            } else {
                const otherView = state.currentView === 'student' ? 'teacher' : 'student';
                const buttonText = state.currentView === 'student' ? 'ចូលប្រព័ន្ធគ្រូ' : 'ចូលប្រព័ន្ធសិស្ស';
                
                const switchBtn = document.createElement('button');
                switchBtn.className = "btn btn-sm btn-light fw-bold";
                setSafeContent(switchBtn, buttonText);
                switchBtn.addEventListener('click', () => { 
                    state.currentView = otherView; 
                    renderApp(); 
                });
                actionContainer.appendChild(switchBtn);
            }

            return header;
        }

        function renderLoading() {
            const div = document.createElement('div');
            div.className = "text-center py-5 mt-5";
            setSafeContent(div, `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">កំពុងផ្ទុក...</span></div><p class="mt-3 text-muted">កំពុងទាញយកទិន្នន័យពី Google Sheet...</p>`, 'innerHTML');
            return div;
        }

        function renderError() {
            const div = document.createElement('div');
            div.className = "container app-container mx-auto px-3 mt-4";
            
            let message;
            if (state.error === "PUBLISH_ERROR") {
                message = `
                    <p class="mb-3">Google Sheet កំពុងបញ្ជូនទិន្នន័យជាទម្រង់ HTML ជំនួសឱ្យ CSV ។ សូមកែតម្រូវការកំណត់បោះពុម្ព។</p>
                    <div class="bg-white p-3 rounded shadow-sm text-sm border">
                        <strong>វិធីដោះស្រាយ:</strong>
                        <ol class="list-unstyled mt-2 small">
                            <li>1. ចូលទៅកាន់ Google Sheet របស់អ្នក។</li>
                            <li>2. ចុច <strong>ឯកសារ &gt; ចែករំលែក &gt; បោះពុម្ពទៅកាន់បណ្តាញ</strong>។</li>
                            <li>3. ប្តូរ "Web Page" ទៅជា <strong>តម្លៃបំបែកដោយសញ្ញាក្បៀស (.csv)</strong>។</li>
                            <li>4. ផ្ទុកទំព័រនេះឡើងវិញ។</li>
                        </ol>
                    </div>`;
            } else {
                message = `<p>មានបញ្ហាក្នុងការភ្ជាប់បណ្តាញ។ សូមព្យាយាមម្តងទៀត។</p>`;
            }
            
            setSafeContent(div, `
                <div class="alert alert-danger shadow-sm border-start-0 border-end-0" role="alert">
                    <h4 class="alert-heading fw-bold d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="m21.73 18-9-15-9 15z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> កំហុស
                    </h4><hr>${message}</div>
            `, 'innerHTML');
            
            return div;
        }

        function renderInitialView() {
            const div = document.createElement('div');
            div.className = "container app-container mx-auto px-3 mt-5";
            const lastUpdateStr = state.lastUpdated ? state.lastUpdated.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'N/A';
            const intervalText = `ធ្វើបច្ចុប្បនភាពស្វ័យប្រវត្តិរៀងរាល់ ១នាទី`;

            // This structure is mostly static layout, so innerHTML is acceptable for the main template, 
            // but dynamic content must be handled carefully.
            setSafeContent(div, `
                <div class="card shadow-lg border-0 mx-auto" style="max-width: 400px;">
                    <div class="card-header p-0 no-print">
                        <ul class="nav nav-tabs nav-fill border-0" id="loginTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-bold ${state.currentView === 'student' ? 'active bg-white' : ''} rounded-top-0" id="student-tab" type="button" role="tab" aria-controls="student-tab-pane" aria-selected="${state.currentView === 'student' ? 'true' : 'false'}">សិស្ស (ស្វែងរក)</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-bold ${state.currentView === 'teacher' ? 'active bg-white' : ''} rounded-top-0" id="teacher-tab" type="button" role="tab" aria-controls="teacher-tab-pane" aria-selected="${state.currentView === 'teacher' ? 'true' : 'false'}">គ្រូបង្រៀន</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-4 text-center">
                        <div class="tab-content" id="loginTabsContent">
                            <div class="tab-pane fade ${state.currentView === 'student' ? 'show active' : ''}" id="student-tab-pane" role="tabpanel" aria-labelledby="student-tab" tabindex="0">
                                <div class="p-3 bg-blue-100 rounded-circle d-inline-flex mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                </div>
                                <h2 class="h5 card-title fw-bold">ពិនិត្យលទ្ធផលរបស់អ្នក</h2>
                                <p class="text-muted mb-4">បញ្ចូលអត្តលេខសិស្ស (ID) ពេញលេញ</p>
                                <form id="search-form">
                                    <input type="text" id="search-input" class="form-control form-control-lg text-center fw-bold mb-3" placeholder="បញ្ចូលអត្តលេខពេញលេញ..." value="${state.searchId}" required/>
                                    <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold shadow-sm d-flex justify-content-center align-items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                        <span>ស្វែងរកលទ្ធផល</span>
                                    </button>
                                </form>
                                <div id="search-message"></div>
                            </div>
                            <div class="tab-pane fade ${state.currentView === 'teacher' ? 'show active' : ''}" id="teacher-tab-pane" role="tabpanel" aria-labelledby="teacher-tab" tabindex="0">
                                <div class="p-3 bg-blue-100 rounded-circle d-inline-flex mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M14.5 10c.84-.79 1.48-1.73 1.93-2.8h-7.66c.45 1.07 1.09 2.01 1.93 2.8z"/><path d="M12 15a3 3 0 0 0-3 3v2h6v-2a3 3 0 0 0-3-3z"/><path d="M12 22s8-4 8-10c0-4.42-3.58-8-8-8s-8 3.58-8 8c0 6 8 10 8 10z"/></svg>
                                </div>
                                <h2 class="h5 card-title fw-bold">ការចូលរបស់គ្រូបង្រៀន</h2>
                                <p class="text-muted mb-4">បញ្ចូលឈ្មោះអ្នកប្រើប្រាស់ និងពាក្យសម្ងាត់</p>
                                
                                <form id="teacher-login-form">
                                    <input type="text" id="teacher-username" class="form-control form-control-lg fw-bold mb-3" placeholder="ឈ្មោះអ្នកប្រើប្រាស់" required/>
                                    <input type="password" id="teacher-password" class="form-control form-control-lg fw-bold mb-3" placeholder="ពាក្យសម្ងាត់" required/>
                                    <button type="submit" class="btn btn-success btn-lg w-100 fw-bold shadow-sm d-flex justify-content-center align-items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                                        <span>ចូល</span>
                                    </button>
                                </form>
                                <div id="login-message"></div>
                            </div>
                        </div>

                        <div class="mt-4 pt-3 border-top border-light text-start">
                            <div class="d-flex justify-content-center align-items-center gap-2 text-sm text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-success"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                                <span>${state.data.length} កំណត់ត្រាដំណើរការ</span>
                            </div>
                            <div class="d-flex justify-content-center align-items-center gap-2 text-xs text-muted mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-info"><path d="M2 12s3-3 8-3 8 3 8 3M2 12s3 3 8 3 8-3 8-3"/></svg>
                                <span>ធ្វើបច្ចុប្បនភាពចុងក្រោយ: ${lastUpdateStr} (${intervalText})</span>
                            </div>
                        </div>
                    </div>
                </div>
            `, 'innerHTML'); // Trusting the static structure here

            // Attach listeners to the dynamically created tabs after injecting HTML
            div.querySelectorAll('.nav-link').forEach(button => {
                button.addEventListener('click', (e) => {
                    const view = e.target.id.includes('student') ? 'student' : 'teacher';
                    state.currentView = view;
                    renderApp();
                });
            });

            return div;
        }

        function renderResults(stats) {
            const container = document.createElement('div');
            container.className = "container app-container mx-auto px-3 mt-4";

            const { totalQHAValue, midtermValue, qhaGradeStatus, midtermGradeStatus, detailedScores, rank, totalStudentsInSheet } = stats;
            const lastUpdateStr = state.lastUpdated ? state.lastUpdated.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'N/A';
            const intervalText = `ធ្វើបច្ចុប្បនភាពស្វ័យប្រវត្តិរៀងរាល់ ១នាទី`;
            const rankDisplay = rank !== 'N/A' ? `${rank} / ${totalStudentsInSheet}` : `N/A / ${totalStudentsInSheet}`;
            
            const studentInfo = { 
                nameKh: getStudentInfo('nameKh'), 
                nameEn: getStudentInfo('nameEn'), 
                ID: getStudentInfo('id'), 
                LR: getStudentInfo('lr'), 
                Gender: getStudentInfo('gender'), 
                Room: getStudentInfo('room'), 
                Subject: getStudentInfo('subject'), 
                Skill: getStudentInfo('skill') 
            };
            
            // --- Helper for creating a stats card ---
            const createStatCard = (title, value, colorClass, bgClass) => {
                const card = document.createElement('div');
                card.className = "card h-100 p-3 border-0 shadow-sm print:bg-white print:border " + bgClass;
                card.innerHTML = `<p class="small fw-bold ${colorClass} text-uppercase mb-1">${title}</p><h4 class="h4 fw-bolder mb-0 text-dark">${value}</h4>`;
                return card;
            };

            // --- Main Report Card Structure (static safe HTML) ---
            const reportCardHtml = `
                <div class="d-flex justify-content-end gap-2 mb-3 no-print" id="result-actions"></div>
                <div class="card report-card shadow-lg rounded-xl overflow-hidden mb-5">
                    <div class="card-header bg-light p-4 border-bottom print:bg-white print:border-black" id="report-header"></div>
                    <div class="card-body p-4">
                        <h5 class="fw-bold text-secondary mb-3">ព័ត៌មានសិស្ស</h5>
                        <div class="row g-2 small mb-4 bg-gray-100 p-3 rounded-lg print:bg-white print:border">
                            <div class="col-6"><span class="fw-bold">ភេទ:</span> ${studentInfo.Gender}</div>
                            <div class="col-6"><span class="fw-bold">បន្ទប់:</span> ${studentInfo.Room}</div>
                            <div class="col-6"><span class="fw-bold">មុខវិជ្ជា:</span> ${studentInfo.Subject}</div>
                            <div class="col-6"><span class="fw-bold">ជំនាញ:</span> ${studentInfo.Skill}</div>
                        </div>

                        <h5 class="fw-bold text-secondary mb-3">ពិន្ទុសរុប</h5>
                        <div class="row g-3 mb-4" id="aggregate-scores"></div>
                        <h5 class="fw-bold text-secondary mb-3">ស្ថានភាព</h5>
                        <div class="row g-3 mb-4" id="grade-status"></div>

                        <h5 class="fw-bold text-secondary mb-3 mt-4 d-flex align-items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-info"><path d="M12 2v20M17 5H7l-5 5 5 5h10l5-5-5-5z"/></svg>
                            ពិន្ទុលម្អិតលំហាត់ (បច្ចុប្បនភាពស្វ័យប្រវត្តិ)
                        </h5>
                        <div id="detailed-scores-table"></div>
                        
                        <div class="d-none d-print-block mt-5 pt-3 border-top border-secondary">
                            <div class="row small text-muted"><div class="col-6 text-center"><div class="border-bottom border-dark mx-auto mb-2" style="width: 150px;"></div><p>ហត្ថលេខាគ្រូ</p></div><div class="col-6 text-center"><div class="border-bottom border-dark mx-auto mb-2" style="width: 150px;"></div><p>ហត្ថលេខាអ្នកគ្រប់គ្រង</p></div></div>
                        </div>
                    </div>
                </div>
            `;
            setSafeContent(container, reportCardHtml, 'innerHTML');

            // --- Fill in dynamic, possibly user-data-containing sections securely ---

            // 1. Header
            const headerEl = container.querySelector('#report-header');
            headerEl.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div><h2 class="h4 fw-bold mb-0"></h2><p class="text-muted small mb-0"></p></div>
                    <div class="text-end"><p class="mb-0 small fw-bold text-muted text-uppercase">ចំណាត់ថ្នាក់</p><h3 class="h3 fw-bolder text-primary">${rankDisplay}</h3></div>
                </div>
                <p class="text-muted small mb-0 mt-2 no-print">
                    ទិន្នន័យត្រូវបានធ្វើបច្ចុប្បនភាពស្វ័យប្រវត្តិ: ${lastUpdateStr} (${intervalText})
                </p>
            `;
            headerEl.querySelector('h2').textContent = `${studentInfo.nameKh} (${studentInfo.nameEn})`;
            headerEl.querySelector('p:nth-child(2)').textContent = `អត្តលេខ: ${studentInfo.ID} | ល.រ: ${studentInfo.LR}`;

            // 2. Aggregate Scores
            const aggScoresEl = container.querySelector('#aggregate-scores');
            const qhaCol = document.createElement('div'); qhaCol.className = 'col-6';
            qhaCol.appendChild(createStatCard('សរុបពិន្ទុ (Q,H,A)', totalQHAValue || 'N/A', 'text-yellow-700', 'bg-yellow-100'));
            const midtermCol = document.createElement('div'); midtermCol.className = 'col-6';
            midtermCol.appendChild(createStatCard('ពិន្ទុពាក់កណ្តាលឆមាស', midtermValue || 'N/A', 'text-green-700', 'bg-green-100'));
            aggScoresEl.append(qhaCol, midtermCol);

            // 3. Grade Status
            const gradeStatusEl = container.querySelector('#grade-status');
            const qhaStatusCol = document.createElement('div'); qhaStatusCol.className = 'col-6';
            qhaStatusCol.appendChild(createStatCard('ស្ថានភាព QHA (លទ្ធផល QHA)', qhaGradeStatus.label, qhaGradeStatus.color, qhaGradeStatus.bg));
            const midtermStatusCol = document.createElement('div'); midtermStatusCol.className = 'col-6';
            midtermStatusCol.appendChild(createStatCard('ស្ថានភាពពាក់កណ្តាលឆមាស', midtermGradeStatus.label, midtermGradeStatus.color, midtermGradeStatus.bg));
            gradeStatusEl.append(qhaStatusCol, midtermStatusCol);

            // 4. Detailed Scores Table
            const detailedScoresEl = container.querySelector('#detailed-scores-table');
            if (detailedScores.length > 0) {
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'border rounded overflow-hidden';
                const table = document.createElement('table');
                table.className = 'table table-sm table-hover mb-0';
                
                table.innerHTML = `<thead class="bg-light"><tr class="small text-muted text-uppercase"><th class="px-4 py-2">មុខវិជ្ជា / លំហាត់</th><th class="px-4 py-2 text-end">ពិន្ទុ</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');

                detailedScores.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.className = 'align-middle';
                    tr.innerHTML = `<td class="px-4 py-2"></td><td class="px-4 py-2 text-end fw-bold"></td>`;
                    // Safely insert content using textContent
                    setSafeContent(tr.cells[0], s.subject);
                    setSafeContent(tr.cells[1], s.score.toFixed(2));
                    tbody.appendChild(tr);
                });
                
                tableWrapper.appendChild(table);
                detailedScoresEl.appendChild(tableWrapper);
            } else {
                detailedScoresEl.innerHTML = `<div class="alert alert-warning small">រកមិនឃើញពិន្ទុលម្អិត (ត្រូវប្រាកដថាជួរឈរពិន្ទុរបស់អ្នកជាលេខ)។</div>`;
            }

            // 5. Attach event listeners for buttons
            const actionsEl = container.querySelector('#result-actions');
            
            // AI Feedback Button
            const feedbackBtn = document.createElement('button');
            feedbackBtn.className = `btn btn-sm btn-success fw-bold d-flex align-items-center gap-2`;
            feedbackBtn.disabled = state.feedbackLoading;
            feedbackBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94a10 10 0 1 0 0-17.88 10 10 0 0 0 0 17.88zM12 11.5v4M12 8.5h.01"/></svg> <span>${state.feedbackLoading ? 'កំពុងវិភាគ...' : 'ទទួលបានមតិកែលម្អការសិក្សា'}</span>`;
            feedbackBtn.addEventListener('click', () => getLLMFeedback(stats));
            actionsEl.appendChild(feedbackBtn);

            // Refresh Button
            const refreshBtn = document.createElement('button');
            refreshBtn.className = `btn btn-sm btn-outline-primary fw-bold d-flex align-items-center gap-2`;
            refreshBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M21.5 8a10 10 0 0 0-18.7-2"/><path d="M2.5 16a10 10 0 0 0 18.7 2"/></svg> <span>ធ្វើបច្ចុប្បនភាពទិន្នន័យ</span>`;
            refreshBtn.addEventListener('click', handleManualRefresh);
            actionsEl.appendChild(refreshBtn);

            // Print Button
            const printBtn = document.createElement('button');
            printBtn.className = `btn btn-sm btn-outline-secondary fw-bold d-flex align-items-center gap-2`;
            printBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> <span>បោះពុម្ពរបាយការណ៍</span>`;
            printBtn.addEventListener('click', () => window.print());
            actionsEl.appendChild(printBtn);
            
            return container;
        }

        function renderTeacherView() {
            const teacherStats = calculateTeacherStatistics();
            const isAggregateMode = state.teacherDataTableMode === 'aggregate';

            const container = document.createElement('div');
            container.className = "container app-container mx-auto px-3 mt-4";
            
            const cardHtml = `
                <h2 class="h4 fw-bold mb-3 text-primary">ទិដ្ឋភាពគ្រូបង្រៀន</h2>
                <div class="card report-card shadow-xl rounded-2xl mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold text-secondary mb-3 d-flex align-items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                            ស្ថិតិថ្នាក់សរុប
                        </h5>
                        <div class="row g-3 mb-4" id="teacher-stats-dashboard"></div>
                        
                        <div class="row mb-3 g-2 no-print align-items-center border-bottom pb-3" id="teacher-actions-row"></div>
                        
                        <div class="col-12 mt-2">
                            <div class="alert alert-warning p-2 small mb-4 fw-bold">
                                ចំណាំសំខាន់សម្រាប់ការនាំចេញ PDF៖ សូមប្រើប៊ូតុង "បោះពុម្ពរបាយការណ៍" នៅក្នុងទិដ្ឋភាពលទ្ធផលសិស្ស (Student Result View) ហើយជ្រើសរើស "Save as PDF" ពីកម្មវិធីរុករករបស់អ្នកជំនួសវិញ។
                            </div>
                        </div>

                        <div class="table-responsive teacher-table mt-4 p-2 rounded-lg border shadow-md">
                            <table id="teacher-data-table" class="table table-striped table-bordered w-100 align-middle">
                                <thead>
                                    <tr id="teacher-table-headers"></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            setSafeContent(container, cardHtml, 'innerHTML');
            
            // --- 1. Stats Dashboard ---
            const statsEl = container.querySelector('#teacher-stats-dashboard');
            
            const createDashboardCard = (title, value, unit, bgColor) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-2';
                const card = document.createElement('div');
                card.className = `card p-3 shadow-sm border-0 ${bgColor}`;
                card.innerHTML = `<p class="small mb-1 fw-bold ${bgColor.includes('bg-warning') ? 'text-dark' : 'text-white'}">${title}</p><h4 class="h4 fw-bolder ${bgColor.includes('bg-warning') ? 'text-dark' : 'text-white'}">${value} ${unit}</h4>`;
                col.appendChild(card);
                return col;
            };

            statsEl.appendChild(createDashboardCard('សិស្សសរុប', teacherStats.totalStudents, 'នាក់', 'bg-secondary'));
            statsEl.appendChild(createDashboardCard('ពិន្ទុ Midterm មធ្យម', teacherStats.avgMidterm, '', 'bg-primary'));
            statsEl.appendChild(createDashboardCard('អត្រាជាប់ Midterm', teacherStats.passRateMidterm, '%', 'bg-info'));
            statsEl.appendChild(createDashboardCard('ពិន្ទុ QHA មធ្យម', teacherStats.avgQHA, '', 'bg-warning'));
            statsEl.appendChild(createDashboardCard('QHA ល្អ (≥ 7.5)', teacherStats.goodRateQHA, '%', 'bg-success'));

            // --- 2. Action Row (Buttons and Tabs) ---
            const actionsRow = container.querySelector('#teacher-actions-row');
            
            // Export Button
            const exportCol = document.createElement('div');
            exportCol.className = 'col-12 col-md-4';
            const exportBtn = document.createElement('button');
            exportBtn.className = "btn btn-sm btn-success fw-bold d-flex align-items-center gap-2";
            exportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" x2="12" y1="18" y2="12"/><path d="M12 12l-4 4"/></svg> <span>ទាញយក CSV (សម្រាប់ Excel)</span>`;
            exportBtn.addEventListener('click', exportCSV);
            exportCol.appendChild(exportBtn);
            actionsRow.appendChild(exportCol);

            // View Switcher Tabs
            const tabsCol = document.createElement('div');
            tabsCol.className = 'col-12 col-md-4 d-flex justify-content-center';
            tabsCol.innerHTML = `
                <ul class="nav nav-tabs teacher-view-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isAggregateMode ? 'active' : ''}" data-mode="aggregate" type="button">ពិន្ទុសរុប</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${!isAggregateMode ? 'active' : ''}" data-mode="detailed" type="button">ពិន្ទុលម្អិត</button>
                    </li>
                </ul>`;
            tabsCol.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => setTeacherDataTableMode(e.target.dataset.mode));
            });
            actionsRow.appendChild(tabsCol);

            // Sync Button
            const syncCol = document.createElement('div');
            syncCol.className = 'col-12 col-md-4 d-flex justify-content-end';
            const syncBtn = document.createElement('button');
            syncBtn.className = "btn btn-sm btn-outline-primary fw-bold d-flex align-items-center gap-2";
            syncBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M21.5 8a10 10 0 0 0-18.7-2"/><path d="M2.5 16a10 10 0 0 0 18.7 2"/></svg> <span>ធ្វើសមកាលកម្មទិន្នន័យ (60s)</span>`;
            syncBtn.addEventListener('click', handleManualRefresh);
            syncCol.appendChild(syncBtn);
            actionsRow.appendChild(syncCol);
            
            // --- 3. Table Headers ---
            const indexes = state.colIndexes;
            const infoIndexes = CORE_INFO_HEADERS
                .map(hKey => indexes[Object.keys(INFO_HEADERS).find(k => INFO_HEADERS[k] === hKey)])
                .filter(i => i !== undefined && i !== -1);
            
            let columnIndexesToShow = [];
            if (isAggregateMode) {
                const aggIndexes = AGGREGATE_SCORE_HEADERS
                    .map(hKey => indexes[Object.keys(INFO_HEADERS).find(k => INFO_HEADERS[k] === hKey)])
                    .filter(i => i !== undefined && i !== -1);
                columnIndexesToShow = [...new Set([...infoIndexes, ...aggIndexes])];
            } else {
                const allUnique = [...new Set(Array.from({ length: state.headers.length }, (_, i) => i))];
                const infoSet = new Set(infoIndexes);
                columnIndexesToShow = infoIndexes.concat(allUnique.filter(i => !infoSet.has(i)));
            }
            
            const tableHeadersEl = container.querySelector('#teacher-table-headers');
            columnIndexesToShow.forEach(index => {
                const th = document.createElement('th');
                th.className = 'px-2 py-2 teacher-table-header';
                setSafeContent(th, state.headers[index]);
                tableHeadersEl.appendChild(th);
            });
            
            return container;
        }

        // --- MAIN RENDER LOOP ---
        function renderApp() {
            let contentElement;
            
            // Destroy existing DataTables instance before rendering new content
            if (window.jQuery && $.fn.DataTable.isDataTable('#teacher-data-table')) {
                 $('#teacher-data-table').DataTable().destroy();
                 $('#teacher-data-table').empty(); // Clear content
            }

            if (state.loading) {
                contentElement = renderLoading();
            } else if (state.error) {
                contentElement = renderError();
            } else if (state.isTeacher) {
                contentElement = renderTeacherView();
            } else if (state.student) {
                const stats = calculateStats(state.student);
                contentElement = renderResults(stats);
            } else {
                // Initial login/search view
                contentElement = renderInitialView();
            }
            
            // Combine Header and Content
            const headerElement = renderHeader();
            root.innerHTML = ''; // Clear existing content
            root.appendChild(headerElement);
            root.appendChild(contentElement);
            
            // --- POST-RENDER ACTIONS ---
            if (!state.loading && !state.error) {
                if (state.isTeacher) {
                    // Initialize DataTables after the table element is in the DOM
                    setupDataTable();
                } else if (!state.student) {
                    // Attach form listeners for the currently active tab
                    if (state.currentView === 'student') {
                        const searchForm = document.getElementById('search-form');
                        if (searchForm) searchForm.addEventListener('submit', handleSearch);
                    } else if (state.currentView === 'teacher') {
                        const loginForm = document.getElementById('teacher-login-form');
                        if(loginForm) loginForm.addEventListener('submit', handleTeacherLogin);
                    }
                }
            }
        }
        
        // --- INITIALIZATION ---
        window.onload = () => {
            fetchData();
        };
    </script>
</body>
</html>
